name: CI/CD Pipeline

on:
  push:
    branches: ['**']    
  pull_request:
    branches: ['**']

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      - name: Install backend deps
        run: |
          cd backend
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Run basic test (health endpoint)
        run: |
          # simple smoke test: start backend with sqlite for CI
          cd backend
          FLASK_APP=app.py python -c "from app import create_app; app=create_app(); print('app ready')"

  tfsec-scan:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4
      - name: Install tfsec
        run: |
          curl -sSL https://github.com/aquasecurity/tfsec/releases/latest/download/tfsec-linux-amd64 > /tmp/tfsec && sudo install /tmp/tfsec /usr/local/bin/tfsec
      - name: Run tfsec
        working-directory: infra
        run: tfsec .

  build-and-scan:
    runs-on: ubuntu-latest
    needs: [test, tfsec-scan]
    env:
      REGISTRY: ghcr.io
      IMAGE_NAME_BACKEND: ${{ github.repository }}-backend
      IMAGE_NAME_FRONTEND: ${{ github.repository }}-frontend
    steps:
      - uses: actions/checkout@v4
      - name: Log in to GHCR
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build backend image
        run: docker build -t $REGISTRY/${{ env.IMAGE_NAME_BACKEND }}:latest ./backend
      - name: Build frontend image
        run: docker build -t $REGISTRY/${{ env.IMAGE_NAME_FRONTEND }}:latest ./frontend
      - name: Install Trivy
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
      - name: Scan backend image
        run: |
          /usr/local/bin/trivy image --exit-code 1 --severity CRITICAL,HIGH $REGISTRY/${{ env.IMAGE_NAME_BACKEND }}:latest || true
      - name: Scan frontend image
        run: |
          /usr/local/bin/trivy image --exit-code 1 --severity CRITICAL,HIGH $REGISTRY/${{ env.IMAGE_NAME_FRONTEND }}:latest || true
      - name: Push images to GHCR
        run: |
          docker push $REGISTRY/${{ env.IMAGE_NAME_BACKEND }}:latest
          docker push $REGISTRY/${{ env.IMAGE_NAME_FRONTEND }}:latest

  deploy:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    needs: build-and-scan
    env:
      TF_VAR_db_password: ${{ secrets.TF_VAR_DB_PASSWORD }}
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.5.7

      - name: Terraform Init
        working-directory: infra
        run: terraform init -backend-config="bucket=${{ secrets.TFSTATE_BUCKET }}" -backend-config="region=${{ secrets.AWS_REGION }}" -backend-config="key=infra/terraform.tfstate" -backend-config="dynamodb_table=${{ secrets.TFSTATE_LOCK_TABLE }}"

      - name: Terraform Plan
        working-directory: infra
        run: terraform plan -var="db_password=${{ secrets.TF_VAR_DB_PASSWORD }}" -out=tfplan

      - name: Terraform Apply
        working-directory: infra
        run: terraform apply -auto-approve tfplan

      - name: Wait for EC2 SSH available
        run: |
          # get ec2 ip (requires AWS CLI)
          EC2_IP=$(aws ec2 describe-instances --filters "Name=tag:Name,Values=inventory-app-ec2" "Name=instance-state-name,Values=running" --query "Reservations[0].Instances[0].PublicIpAddress" --output text)
          echo "EC2_IP=$EC2_IP" >> $GITHUB_ENV

      - name: Copy docker-compose to EC2 & deploy
        env:
          DEPLOY_USER: ubuntu
        uses: appleboy/ssh-action@v0.1.9
        with:
          host: ${{ env.EC2_IP }}
          username: ${{ secrets.EC2_SSH_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            set -e
            cd /home/ubuntu/app || mkdir -p /home/ubuntu/app
            # create a docker-compose.yml that uses the GHCR images
            cat > /home/ubuntu/app/docker-compose.yml <<'EOF'
            version: '3.8'
            services:
              backend:
                image: ghcr.io/${{ github.repository }}-backend:latest
                environment:
                  DB_HOST: ${RDS_ENDPOINT}
                  DB_USER: ${DB_USER}
                  DB_PASS: ${DB_PASS}
                  DB_NAME: ${DB_NAME}
                ports:
                  - "5000:5000"
              frontend:
                image: ghcr.io/${{ github.repository }}-frontend:latest
                ports:
                  - "80:80"
            EOF
            docker compose -f /home/ubuntu/app/docker-compose.yml pull
            docker compose -f /home/ubuntu/app/docker-compose.yml up -d
